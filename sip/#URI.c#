#include <string.h>
#include <stdlib.h>
#include <stdio.h>

#include "URI.h"
#include "Parser.h"

struct URI {
    char scheme[8];
    char user[32];
    char host[32];
    int  port;
    char parameters[128];
    char headers[128];
};

struct HeaderPattern URIHeaderPattern[] = {
    { "*",  EMPTY,      COLON, 0, OFFSETOF(struct URI, scheme), ParseString,NULL,String2String},
    { "*",  COLON,      AT,    0, OFFSETOF(struct URI, user), ParseString, NULL,String2String},
    { "*",  AT,         ANY, 0, OFFSETOF(struct URI, host), ParseString, NULL,String2String},
    { "*",  COLON,      ANY, 0, OFFSETOF(struct URI, port), ParseInteger, NULL,Integero2String},
    { "*",  SEMICOLON, ANY, 0, OFFSETOF(struct URI, parameters), ParseString, NULL,String2String},
    { "*",  QUESTION,   ANY,0, OFFSETOF(struct URI, headers), ParseString, NULL,String2String},
    {NULL}

};

struct HeaderPattern URINoUserHeaderPattern[] = {
    { "*",  EMPTY,      COLON, 0, OFFSETOF(struct URI, scheme), ParseString,NULL,String2String},
    { "*",  COLON,      ANY, 0, OFFSETOF(struct URI, host), ParseString,NULL,String2String},
    { "*",  COLON,      ANY, 0, OFFSETOF(struct URI, port), ParseInteger,NULL,Integer2String},
    { "*",  SEMICOLON, ANY, 0, OFFSETOF(struct URI, parameters), ParseString,NULL,String2String},
    { "*",  QUESTION,   ANY,0, OFFSETOF(struct URI, headers), ParseString,NULL,String2String},
    {NULL}
};

int ParseURI(char *header, void *target)
{
    struct HeaderPattern *pattern = GetURIHeaderPattern(header);
    struct URI **uri = target;

    Parse(header, *uri, pattern);
    
    return 0;
}

char *UriGetScheme(struct URI *uri)
{
    return uri->scheme;
}

char *UriGetUser(struct URI *uri)
{
    return uri->user;
}

char *UriGetHost(struct URI *uri)
{
    return uri->host;
}

int UriGetPort(struct URI *uri)
{
    return uri->port;
}

char *UriGetParameters(struct URI *uri)
{
    return uri->parameters;
}

char *UriGetHeaders(struct URI *uri)
{
    return uri->headers;
}

void UriSetScheme(struct URI *uri, char *scheme)
{
    struct HeaderPattern *p = &URIHeaderPattern[0];
    Copy2Target(uri, scheme, p);
}
void UriSetUser(struct URI *uri, char *user)
{
    struct HeaderPattern *p = &URIHeaderPattern[1];
    Copy2Target(uri, user, p);

}

void UriSetHost(struct URI *uri, char *host)
{
    struct HeaderPattern *p = &URIHeaderPattern[2];
    Copy2Target(uri, host, p);
}

void UriSetPort(struct URI *uri, int port)
{
    struct HeaderPattern *p = &URIHeaderPattern[3];
    char userString[8] = {0};

    snprintf(userString,sizeof(userString) - 1, "%d",port); 
    Copy2Target(uri, userString, p);
}

void UriSetParameters(struct URI *uri,char *paramater)
{
    struct HeaderPattern *p = &URIHeaderPattern[4];
    Copy2Target(uri, paramater, p);
}

void UriSetHeaders(struct URI *uri, char *headers)
{
    struct HeaderPattern *p = &URIHeaderPattern[5];
    Copy2Target(uri, headers, p);
}

struct URI *CreateEmptyUri()
{
    struct URI *uri = calloc(1, sizeof (struct URI));
    return uri;
}

struct URI *CreateUri(char *scheme, char *user, char *host, int port)
{
    struct URI *uri = CreateEmptyUri();
    UriSetScheme(uri, scheme);
    UriSetUser(uri, user);
    UriSetHost(uri, host);
    UriSetPort(uri, port);

    return uri;
}

struct URI *UriDup(struct URI *uri)
{
    struct URI *dupUri = CreateEmptyUri();
    
    memcpy(dupUri, uri, sizeof (struct URI));
    return dupUri;
}
void DestoryUri(struct URI *uri)
{
    free (uri);
}

struct HeaderPattern *GetURIHeaderPattern (char *header)
{
    if (strchr(header, '@') == NULL)
        return URINoUserHeaderPattern;
    else 
        return URIHeaderPattern;
}

struct HeaderPattern *GetURIHeaderPattern42String(struct URI **uri)
{
    if (strcmp ("", UriGetUser(*uri)) == 0) {
        return URINoUserHeaderPattern;
    }
    else {
        return URIHeaderPattern;
    }
}

char *Uri2String(char *string, void *uri, struct HeaderPattern *p)
{
    struct HeaderPattern *pattern = GetURIHeaderPattern42String(uri);
    struct URI **u = uri;
    
    if (p->startSeparator != EMPTY) {
        *string = p->startSeparator;
        string ++;
    }
    
    return ToString(string, *u, pattern);
}

char *Uri2StringExt(char *string, void *uri, struct HeaderPattern *p)
{
    struct HeaderPattern *pattern = GetURIHeaderPattern42String((struct URI **)&uri);
    return ToString(string, uri, pattern);
}
